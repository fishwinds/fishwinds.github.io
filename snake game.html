<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        *{padding:0; margin:0; -webkit-user-select: none;}
    </style>
    <title>Crazy Snake</title>
</head>
<body>
<a>HighScore: <a id=score>0</a></a>
<br/>
<br/>
<canvas id=cnv> </canvas>
<br/>
<br/>
<button id=btn_p1l style="position:relative;left:0px; width:50px; height:50px; background:#55AAFF;""></button>

<button id=btn_p1r style="position:relative;left:300px; width:50px; height:50px; background:#FF9933;""></button>

<script type="text/javascript">
    // Created by fish
    ///////////////////////////////////////////

    window.onload = function(){
        var cnv = document.querySelector("#cnv"),
            ctx = cnv.getContext("2d"),
            width = window.innerWidth,
            height = window.innerHeight,
            arr=[],farr=[],
            btn= document.getElementById("btn_p1l"),
            btn2= document.getElementById("btn_p1r"),
            score =document.getElementById("score"),
            sc=5
        bControl =true,
            gamespeed = 200,
            bonus = 1;
        cnv.width = 400;//width-14;
        cnv.height = 450//height-172;
        btn.addEventListener("click",turnLeft);
        btn2.addEventListener("click",turnRight);

        score.innerHTML=sc;

        function turnLeft(){
            var t =arr[0];
            if (bControl== true){
                changeDir(t,"left");
                bControl = false;
            }
        }
        function turnRight(){
            var t =arr[0];
            if (bControl== true){
                changeDir(t,"right");
                bControl = false;
            }
        }

        function initDir(obj){
            var dx=[],dy=[],i=0;
            dx[0]=1;
            dx[1]=0;
            dx[2]=-1;
            dx[3]=0;

            dy[0]=0;
            dy[1]=1;
            dy[2]=0;
            dy[3]=-1;
            obj.rx=dx[obj.dir]*obj.s;
            obj.ry=dy[obj.dir]*obj.s;
        }

        function initDirByrxrys(obj){
            var dir,i=0;
            switch(obj.rx){
                case 0:
                    if(obj.ry==obj.s){
                        dir=1;
                    }else{dir=3;}
                    break;
                case obj.s:
                    dir=0;
                    break;
                case -1*obj.s:
                    dir=2;
            }
            return dir
        }

        function changeDir(obj,sTurn){
            var dx=[],dy=[],i=0;
            dx[0]=1;
            dx[1]=0;
            dx[2]=-1;
            dx[3]=0;

            dy[0]=0;
            dy[1]=1;
            dy[2]=0;
            dy[3]=-1;
            if(sTurn=="right"){
                if (obj.dir==3){i=0;}else{i=obj.dir+1;}
            }
            else {
                if (obj.dir==0){i=3;}else{i=obj.dir-1;}
            }
            obj.rx=dx[i]*obj.s;
            obj.ry=dy[i]*obj.s;
            obj.dir=i;
        }

//***********************
        function Snake(x,y,dir,s){
            this.x = x;
            this.y = y;
            this.dir = dir;
            this.rx = 0;
            this.ry = 0;
            this.s = s;
            initDir(this)
            //-------------
            this.draw = function(){
                this.check();

                if (arr[0].bWounded == true){
                    ctx.fillStyle="rgba(150,45,75,1)";}else{
                    ctx.fillStyle="rgba(0,45,75,1)";}

                ctx.fillRect(this.x,this.y,10,10);


                ctx.fillStyle="rgba(255,255,255,1)";
                //ctx.stroke();
            }
            //------------------
            this.check = function(){

                if(this.x >= cnv.width){
                    this.x = 0;
                }else if (this.x <0){
                    this.x = cnv.width
                    this.x = this.x-this.x%10-10;
                }
                if(this.y >= cnv.height){
                    this.y = 0;
                }else if (this.y < 0){
                    this.y = cnv.height;
                    this.y = this.y-this.y%10-10;
                }
                //console.log(this.x);
            }
        }
//*****************************

        function snake(x,y,dir,s,n){
            for (var m=1;m<=n;m++){
                arr.push(new Snake(x,y,dir,s));
            }
        }


        function reverse(arr1){
            var arr2=[];
            for(var i=0;i<arr1.length;i++){
                arr2[arr1.length-i-1]=arr1[i];
            }
            for(var j=0;j<arr1.length;j++){
                arr1[j]=arr2[j];
            }
            return arr1
        }


        function food(n){
            var x,y,m,t,type;
            for (var m=1;m<=n;m++){
                type =0;
                x=(1-Math.random())*cnv.width;
                y=(1-Math.random())*cnv.height;
                x=x-x%10;
                y=y-y%10;
                t=Math.random();
                if(t<0.12){
                    type=1;
                }else if(t<0.3){
                    type=2;
                }else if(t<0.45){
                    type=3;
                }
                farr.push(new Food(x,y,type));
            }
        }

        function Food(x,y,type){
            this.x = x;
            this.y = y;
            this.type = type;

            this.draw = function(){
                switch (type)
                {
                    case 1:
                        ctx.fillStyle="rgba(25,95,25,1)";
                        break;
                    case 2:
                        ctx.fillStyle="rgba(95,95,25,1)";
                        break;
                    case 3:
                        ctx.fillStyle="rgba(95,125,125,1)";
                        break;
                    default:
                        ctx.fillStyle="rgba(55,35,25,1)";
                }
                ctx.fillRect(this.x,this.y,10,10);
                ctx.fillStyle="rgba(255,255,255,1)";
            }
        }

        function grid(){
            for (var i=0;i<=47;i++){
                ctx.lineWidth=0.1
                ctx.strokeStyle="rgba(30,30,30,1)";
                ctx.beginPath();
                ctx.moveTo(i*10,0);
                ctx.lineTo(i*10,1000);
                ctx.moveTo(0,i*10);
                ctx.lineTo(1000,i*10);
                ctx.stroke();
            }
        }

//=========================
        function animate(){
            //requestAnimationFrame(animate);
            //console.log(arr[0].x)
            bControl = true;
            var timer = setTimeout(animate,gamespeed);

            ctx.clearRect(0,0,width,height);
            grid();

            // draw snake
            if(arr.length != 0){
                if(arr[0].bWounded == true){
                    arr.splice(arr.length-1,1);
                    //snake not exist
                    if(arr.length==0){
                        // game over
                        alert("game over");
                        clearTimeout(timer);
                        ctx.clearRect(0,0,width,height);
                        return false;
                    }
                }

                for(var i=arr.length-1;i>=1;i--){
                    arr[i].x= arr[i-1].x;
                    arr[i].y=arr[i-1].y;
                    arr[i].draw();
                }
                arr[0].x += arr[0].rx;
                arr[0].y += arr[0].ry;
                arr[0].draw();

                // eat itself
                for(var i=1;i<arr.length;i++){
                    if(arr[0].x == arr[i].x && arr[0].y == arr[i].y){
                        arr[0].bWounded = true;
                    }
                }
            }

            if(farr.length != 0 && arr.length != 0){
                for(var i=0;i<farr.length;i++){
                    farr[i].draw();
                    //eat food
                    if(arr[0].x==farr[i].x && arr[0].y==farr[i].y){
                        switch(farr[i].type){
                            case 1:
                                arr[0].bWounded = false;
                                break;
                            case 2:
                                gamespeed = gamespeed*0.9;
                                bonus++;
                                break;
                            case 3:
                                var b=arr[0].bWounded
                                arr = reverse(arr)
                                arr[0].bWounded=b
                                arr[0].rx=arr[0].x-arr[1].x;
                                arr[0].ry=arr[0].y-arr[1].y;
                                arr[0].dir=initDirByrxrys(arr[0]);
                        }
                        sc+=bonus;
                        score.innerHTML=sc;
                        farr.splice(i,1);
                        arr.push(new Snake(-99,-99,0,10));
                        if (farr.length<= 15){
                            food(15);
                        }
                        i--;
                    }
                }
            }
            // draw shadow
            for(var i=arr.length-1;i>=0;i--){

                if (arr[0].bWounded == true){
                    ctx.fillStyle="rgba(250,145,175,1)";}else{
                    ctx.fillStyle="rgba(120,195,235,1)";}
                ctx.fillRect(arr[i].x+3,arr[i].y-3,10,10);
            }
            for(var i=farr.length-1;i>=0;i--){
                switch (farr[i].type){
                    case 1:
                        ctx.fillStyle="rgba(125,225,125,1)";
                        break;
                    case 2:
                        ctx.fillStyle="rgba(225,225,125,1)";
                        break;
                    case 3:
                        ctx.fillStyle="rgba(125,255,255,1)"
                        break;
                    default:
                        ctx.fillStyle="rgba(255,135,125,1)";
                }

                ctx.fillRect(farr[i].x+3,farr[i].y-3,10,10);
            }

        }
//==========================

        food(30);
        snake(200,250,2,10,3);
        animate();
    }

</script>
</body>
</html>